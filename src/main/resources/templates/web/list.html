<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title layout:fragment="pageTitle">Danh s√°ch t√≤a nh√† | SkyLand</title>
</head>

<body>
<main layout:fragment="content" class="page-wrapper">

    <!-- üèôÔ∏è INTRO -->
    <section class="intro text-center text-white"
             style="background-image: url('https://bizweb.dktcdn.net/100/328/362/themes/894751/assets/bg_breadcrumb.png?1664350964800');
                    background-size: cover; background-position: center; padding: 60px 0;">
        <h1 class="fw-bold display-5">Danh s√°ch t√≤a nh√†</h1>
        <ul class="list-inline mt-3 mb-0">
            <li class="list-inline-item">
                <a th:href="@{/trang-chu}" class="text-white text-decoration-none">Trang ch·ªß</a>
                <span class="mx-1">/</span>
            </li>
            <li class="list-inline-item"><span class="text-light">T·∫•t c·∫£ t√≤a nh√†</span></li>
        </ul>
    </section>

    <!-- üîç FORM T√åM KI·∫æM -->
    <section class="search py-5 bg-light border-bottom">
        <div class="container">
            <form th:action="@{/san-pham}" method="get" th:object="${search}" class="row g-3">
                <div class="col-md-3">
                    <label class="fw-bold mb-1">T√™n t√≤a nh√†</label>
                    <input type="text" th:field="*{name}" class="form-control" placeholder="V√≠ d·ª•: Sky Tower">
                </div>
                <div class="col-md-3">
                    <label class="fw-bold mb-1">ƒê∆∞·ªùng</label>
                    <input type="text" th:field="*{street}" class="form-control" placeholder="ƒê∆∞·ªùng...">
                </div>
                <div class="col-md-3">
                    <label class="fw-bold mb-1">Ph∆∞·ªùng</label>
                    <input type="text" th:field="*{ward}" class="form-control" placeholder="Ph∆∞·ªùng...">
                </div>
                <div class="col-md-3">
                    <label class="fw-bold mb-1">Qu·∫≠n</label>
                    <select th:field="*{district}" class="form-select">
                        <option value="">-- Ch·ªçn qu·∫≠n --</option>
                        <option th:each="d : ${districts}" th:value="${d.key}" th:text="${d.value}"></option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="fw-bold mb-1">H∆∞·ªõng</label>
                    <input type="text" th:field="*{direction}" class="form-control" placeholder="V√≠ d·ª•: ƒê√¥ng Nam">
                </div>

                <div class="col-md-3">
                    <label class="fw-bold mb-1">S·ªë t·∫ßng h·∫ßm</label>
                    <input type="number" th:field="*{numberOfBasement}" class="form-control" min="0">
                </div>

                <div class="col-md-3">
                    <label class="fw-bold mb-1">Di·ªán t√≠ch s√†n (m¬≤)</label>
                    <input type="number" th:field="*{floorArea}" class="form-control" placeholder="V√≠ d·ª•: 200">
                </div>

                <div class="col-md-3">
                    <label class="fw-bold mb-1">Gi√° thu√™ (t·ª´ - ƒë·∫øn)</label>
                    <div class="input-group">
                        <input type="number" th:field="*{rentPriceFrom}" class="form-control" placeholder="T·ª´">
                        <input type="number" th:field="*{rentPriceTo}" class="form-control" placeholder="ƒê·∫øn">
                    </div>
                </div>

                <div class="col-md-12">
                    <label class="fw-bold mb-1">Lo·∫°i t√≤a nh√†</label>
                    <div class="d-flex flex-wrap gap-3">
                        <div th:each="type : ${typeCodes}" class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" th:field="*{typeCode}"
                                   th:value="${type.key}" id="type__${type.key}">
                            <label class="form-check-label" th:for="'type__' + ${type.key}" th:text="${type.value}"></label>
                        </div>
                    </div>
                </div>

                <div class="col-md-12 text-end mt-3">
                    <button type="submit" class="btn btn-success px-4">
                        <i class="fa-solid fa-magnifying-glass me-2"></i>T√¨m ki·∫øm
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- üìã DANH S√ÅCH T√íA NH√Ä -->
    <section class="product py-5">
        <div class="container">
            <div class="row g-4" th:if="${!#lists.isEmpty(projects)}">
                <div class="col-md-4" th:each="b : ${projects}">
                    <div class="card border-0 shadow-sm h-100">
                    	<!-- üñºÔ∏è HI·ªÇN TH·ªä ·∫¢NH -->
	                    <div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 200px;">
						    <img th:if="${b.imageUrl != null}"
						         th:src="${b.imageUrl}"
						         alt="·∫¢nh t√≤a nh√†"
						         style="width:100%; height:100%; object-fit:contain; object-position:center;">
						</div>

                        <div class="card-body">
                            <h5 class="card-title fw-bold" th:text="${b.name}">Sky Tower</h5>
                            <p class="text-muted mb-2">
							    <i class="fa-solid fa-location-dot text-success me-1"></i>
							    <a th:href="@{https://www.google.com/maps/search/?api=1&query={q}(q=${b.address})}"
							       class="text-decoration-none"
							       target="_blank" rel="noopener"
							       th:text="${b.address}">123 Nguy·ªÖn Hu·ªá</a>
							</p>

							<!-- N√∫t m·ªü Google Maps -->
							<a th:href="@{https://www.google.com/maps/search/?api=1&query={q}(q=${b.address})}"
							   class="btn btn-outline-success btn-sm mb-3"
							   target="_blank" rel="noopener">
							   <i class="fa-solid fa-map-location-dot me-1"></i> Xem tr√™n Google Maps
							</a>

                            <ul class="list-unstyled small mb-3">
                                <li>üìê Di·ªán t√≠ch s√†n: <span th:text="${b.floorArea} + ' m¬≤'">200 m¬≤</span></li>
                                <li>üìû Qu·∫£n l√Ω: <span th:text="${b.managerName}">Nguy·ªÖn VƒÉn A</span> (<span th:text="${b.managerPhone}">0909123456</span>)</li>
                                <li>üí∞ Gi√° thu√™: <span th:text="${b.rentPrice}">25</span> tri·ªáu</li>                           
                            </ul>
                            <div class="d-grid gap-2 mt-3">
							    <a th:href="@{'/chi-tiet-toa-nha/' + ${b.id}}"
							       class="btn btn-outline-success fw-bold">
							        üëÅÔ∏è Xem chi ti·∫øt
							    </a>
							    <button type="button"
							            class="btn btn-success fw-bold"
							            th:attr="data-id=${b.id}, data-name=${b.name}, data-price=${b.rentPrice}"
							            onclick="payDeposit(this)">
							        üí∞ ƒê·∫∑t c·ªçc ngay
							    </button>
							</div>                 
                        </div>
                    </div>
                </div>
            </div>

            <!-- üï≥Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu -->
            <div th:if="${#lists.isEmpty(projects)}" class="text-center mt-5 text-muted">
                <i class="fa-solid fa-box-open fa-2x mb-3"></i>
                <p>Hi·ªán ch∆∞a c√≥ t√≤a nh√† n√†o ƒë∆∞·ª£c ƒëƒÉng.</p>
            </div>
        </div>
    </section>

</main>
<!-- ‚úÖ SCRIPT THANH TO√ÅN VNPAY -->
<!-- ‚úÖ ƒê·∫∑t script v√†o fragment n√†y -->
<th:block layout:fragment="scripts">
<script>
async function payDeposit(btn) {
    const buildingId = btn.getAttribute("data-id");
    const buildingName = btn.getAttribute("data-name");
    const rentPrice = parseFloat(btn.getAttribute("data-price")) || 0;

    // üí° Ti·ªÅn c·ªçc = 10% gi√° thu√™ (tri·ªáu ‚Üí VND)
    const depositAmount = rentPrice * 0.1 * 1_000_000;

    const payload = {
        amount: depositAmount,
        buildingId: buildingId,
        customerId: 1,
        type: "DATCOC",
        note: `ƒê·∫∑t c·ªçc t√≤a nh√† ${buildingName}`
    };

    console.log("‚úÖ payDeposit() ch·∫°y, payload:", payload);

    try {
        const res = await fetch('http://localhost:8092/api/payment/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        console.log("üîπ Response status:", res.status);

        if (!res.ok) {
            const text = await res.text();
            console.error("‚ùå Server returned error:", text);
            alert("M√°y ch·ªß l·ªói, m√£: " + res.status);
            return;
        }

        const result = await res.json();
        console.log("üîπ Response data:", result);

        if (result.message === 'success') {
            alert("‚úÖ T·∫°o ƒë∆°n thanh to√°n th√†nh c√¥ng ‚Äî chuy·ªÉn sang VNPay...");
            window.location.href = result.data;
        } else {
            alert("‚ùå Kh√¥ng th·ªÉ t·∫°o thanh to√°n: " + result.message);
        }
    } catch (err) {
        console.error("‚ö†Ô∏è Fetch error:", err);
        alert("‚ö†Ô∏è L·ªói k·∫øt n·ªëi m√°y ch·ªß thanh to√°n.");
    }
}
</script>

<!-- ‚úÖ N√öT ZALO N·ªîI -->
<a href="https://zalo.me/0896980501"
   target="_blank"
   id="zaloButton"
   title="Li√™n h·ªá qua Zalo">
  <img th:src="@{/images/zalo-icon.png}" alt="Zalo">
</a>

<style>
#zaloButton {
  position: fixed;
  bottom: 80px;
  right: 25px;
  z-index: 1000;
  background: white;
  border: 2px solid #198754; /* Xanh l√° SkyLand */
  border-radius: 50%;
  width: 55px;
  height: 55px;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 3px 10px rgba(0,0,0,0.25);
  transition: transform 0.2s;
}
#zaloButton:hover {
  transform: scale(1.1);
}
#zaloButton img {
  width: 38px;
  height: 38px;
}
</style>

</th:block>
</body>
</html>
