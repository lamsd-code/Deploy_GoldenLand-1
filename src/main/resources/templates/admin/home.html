<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <title layout:fragment="pageTitle">Trang ch·ªß qu·∫£n tr·ªã | SkyLand</title>
</head>

<body>
<main layout:fragment="content" class="container py-5">

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-light p-3 rounded shadow-sm">
            <li class="breadcrumb-item">
                <i class="fa-solid fa-house text-success me-1"></i>
                <a th:href="@{/admin/home}" class="text-decoration-none text-success">Trang ch·ªß</a>
            </li>
            <li class="breadcrumb-item active text-muted" aria-current="page">T·ªïng quan</li>
        </ol>
    </nav>

    <!-- N·ªôi dung ch√≠nh -->
    <section class="dashboard-content">
        <div class="row g-4">

            <!-- Th·ªëng k√™ ng∆∞·ªùi d√πng -->
            <div class="col-md-3">
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center">
                        <i class="fa-solid fa-users fa-2x text-primary mb-2"></i>
                        <h5 class="fw-bold mb-0">Ng∆∞·ªùi d√πng</h5>
                        <p class="text-muted small">Qu·∫£n l√Ω t√†i kho·∫£n h·ªá th·ªëng</p>
                        <a th:href="@{/admin/user-list}" class="btn btn-outline-primary btn-sm mt-2">Xem chi ti·∫øt</a>
                    </div>
                </div>
            </div>

            <!-- Th·ªëng k√™ kh√°ch h√†ng -->
            <div class="col-md-3">
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center">
                        <i class="fa-solid fa-user-tie fa-2x text-success mb-2"></i>
                        <h5 class="fw-bold mb-0">Kh√°ch h√†ng</h5>
                        <p class="text-muted small">Danh s√°ch kh√°ch h√†ng & giao d·ªãch</p>
                        <a th:href="@{/admin/customer-list}" class="btn btn-outline-success btn-sm mt-2">Xem chi ti·∫øt</a>
                    </div>
                </div>
            </div>

            <!-- Th·ªëng k√™ t√≤a nh√† -->
            <div class="col-md-3">
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center">
                        <i class="fa-solid fa-building fa-2x text-warning mb-2"></i>
                        <h5 class="fw-bold mb-0">T√≤a nh√†</h5>
                        <p class="text-muted small">Danh s√°ch t√≤a nh√† qu·∫£n l√Ω</p>
                        <a th:href="@{/admin/building-list}" class="btn btn-outline-warning btn-sm mt-2">Xem chi ti·∫øt</a>
                    </div>
                </div>
            </div>

            <!-- Th·ªëng k√™ c√° nh√¢n -->
            <div class="col-md-3">
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center">
                        <i class="fa-solid fa-circle-user fa-2x text-danger mb-2"></i>
                        <h5 class="fw-bold mb-0">H·ªì s∆° c√° nh√¢n</h5>
                        <p class="text-muted small">C·∫≠p nh·∫≠t th√¥ng tin & m·∫≠t kh·∫©u</p>
                        <a th:href="@{/admin/profile}" class="btn btn-outline-danger btn-sm mt-2">C·∫≠p nh·∫≠t</a>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <!-- Bi·ªÉu ƒë·ªì ho·∫∑c th·ªëng k√™ n√¢ng cao -->
    <section class="mt-5">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <h5 class="fw-bold mb-3 text-success">
                    <i class="fa-solid fa-chart-line me-2"></i>Th·ªëng k√™ nhanh
                </h5>
                <p class="text-muted">Doanh thu, kh√°ch h√†ng, t√≤a nh√† trong nƒÉm hi·ªán t·∫°i.</p>

                <!-- Bi·ªÉu ƒë·ªì -->
                <div style="width: 100%; height: 450px;">
                    <canvas id="dashboardChart" height="420"></canvas>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", async () => {
        const ctx = document.getElementById("dashboardChart").getContext("2d");
        const response = await fetch("/admin/dashboard-data");
        const data = await response.json();

        // üóì L·∫•y th√°ng & nƒÉm hi·ªán t·∫°i
        const now = new Date();
        const currentMonth = now.getMonth() + 1;
        const currentYear = now.getFullYear();

        // G·∫Øn nƒÉm v√†o nh√£n (Th√°ng 1 / 2025)
        const labelsWithYear = data.labels.map(label => {
            const monthNum = parseInt(label.replace("Th√°ng ", ""));
            return `Th√°ng ${monthNum} / ${currentYear}`;
        });

        // üåü L√†m n·ªïi b·∫≠t th√°ng hi·ªán t·∫°i
        const pointRadiusArr = labelsWithYear.map((_, i) => (i + 1 === currentMonth ? 8 : 3));
        const pointBgColorArr = labelsWithYear.map((_, i) => (i + 1 === currentMonth ? 'rgba(255, 205, 86, 1)' : 'white'));

        // üöÄ V·∫Ω bi·ªÉu ƒë·ªì
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labelsWithYear,
                datasets: [
                    {
                        label: 'Doanh thu (VND)',
                        data: data.revenues,
                        borderColor: 'rgba(75, 192, 192, 0.9)',
                        backgroundColor: 'rgba(75, 192, 192, 0.15)',
                        borderWidth: 2,
                        pointRadius: pointRadiusArr,
                        pointBackgroundColor: pointBgColorArr,
                        tension: 0.35,
                        yAxisID: 'y1'
                    },
                    {
                        label: 'Kh√°ch h√†ng m·ªõi',
                        data: data.customers,
                        borderColor: 'rgba(255, 99, 132, 0.9)',
                        backgroundColor: 'rgba(255, 99, 132, 0.15)',
                        borderWidth: 2,
                        pointRadius: pointRadiusArr,
                        pointBackgroundColor: pointBgColorArr,
                        tension: 0.35,
                        yAxisID: 'y2'
                    },
                    {
                        label: 'T√≤a nh√† m·ªõi',
                        data: data.buildings,
                        borderColor: 'rgba(255, 205, 86, 0.9)',
                        backgroundColor: 'rgba(255, 205, 86, 0.15)',
                        borderWidth: 2,
                        pointRadius: pointRadiusArr,
                        pointBackgroundColor: pointBgColorArr,
                        tension: 0.35,
                        yAxisID: 'y2'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 15, right: 20, left: 15, bottom: 10 } },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { boxWidth: 12, padding: 10, font: { size: 13 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const val = ctx.parsed.y;
                                if (ctx.dataset.label.includes('Doanh thu'))
                                    return val.toLocaleString('vi-VN') + ' ‚Ç´';
                                return val + ' ng∆∞·ªùi / t√≤a nh√†';
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: `Bi·ªÉu ƒë·ªì th·ªëng k√™ nƒÉm ${currentYear}`,
                        font: { size: 16, weight: 'bold' },
                        padding: { bottom: 20 }
                    }
                },
                scales: {
                	  x: {
                	    title: { display: true, text: 'Th√°ng', font: { size: 13 } },
                	    ticks: { font: { size: 12 }, maxRotation: 0, minRotation: 0 },
                	    grid: { color: 'rgba(0,0,0,0.05)' }
                	  },
                	  y1: {
                	    type: 'linear',
                	    position: 'left',
                	    suggestedMin: 0,
                	    // üëâ n·∫øu m·∫£ng to√†n 0 th√¨ d√πng gi√° tr·ªã t·∫°m 1_000_000 ƒë·ªÉ tr·ª•c v·∫´n v·∫Ω ƒë∆∞·ª£c
                	    suggestedMax:
                	      (Math.max(...data.revenues) > 0
                	        ? Math.max(...data.revenues) * 1.25 // cao h∆°n 25%
                	        : 1_000_000),
                	    title: { display: true, text: 'Doanh thu (VND)', font: { size: 13 } },
                	    ticks: {
                	      font: { size: 11 },
                	      callback: (val) => val.toLocaleString('vi-VN') + ' ‚Ç´'
                	    },
                	    grid: { color: 'rgba(0,0,0,0.08)' }
                	  },
                	  y2: {
                	    type: 'linear',
                	    position: 'right',
                	    suggestedMin: 0,
                	    suggestedMax:
                	      (Math.max(...data.customers.concat(data.buildings)) > 0
                	        ? Math.max(...data.customers.concat(data.buildings)) * 1.25
                	        : 5), // cho default = 5 ƒë·ªÉ hi·ªÉn th·ªã t·ªët khi to√†n 0
                	    title: { display: true, text: 'S·ªë l∆∞·ª£ng', font: { size: 13 } },
                	    ticks: { font: { size: 11 } },
                	    grid: { drawOnChartArea: false }
                	  }
                	}

            }
        });
    });
    </script>


</main>
</body>
</html>
